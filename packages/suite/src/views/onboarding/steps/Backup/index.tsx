import React, { useState } from 'react';
import styled from 'styled-components';
import { Checkbox, Prompt } from '@trezor/components';
import { P, Link } from '@trezor/components-v2';
import { Translation } from '@suite-components/Translation';

import colors from '@suite/config/onboarding/colors';
import { SEED_MANUAL_URL } from '@suite/constants/onboarding/urls';
import { BACKUP_DEVICE } from '@suite/actions/onboarding/constants/calls';
import l10nCommonMessages from '@suite-support/Messages';
import { Wrapper, Text, OnboardingButton } from '@onboarding-components';
import SeedCard from './components/SeedCard';
import Instructions from './components/Instructions';
import { Props } from './Container';
import l10nMessages from './index.messages';

const Panel = styled(P)`
    background-color: ${colors.grayLight};
    color: ${colors.grayDark};
    padding: 15px;
    margin-top: 10px;
    margin-bottom: 10px;
`;

const PromptWrapper = styled.div`
    margin-top: 30px;
`;

const BackupStep = (props: Props) => {
    const { device, deviceCall, uiInteraction, activeSubStep } = props;

    const [userUnderstands, setUserUnderstands] = useState(false);

    if (!device || !device.features) {
        return null;
    }

    const { features } = device;
    const model = features.major_version;

    const getStatus = () => {
        if (features.initialized === false || features.unfinished_backup) {
            return 'failed';
        }
        if (features.needs_backup === false && !deviceCall.isProgress) {
            return 'success';
        }
        if (
            features.needs_backup &&
            typeof uiInteraction.counter === 'number' &&
            deviceCall.name === BACKUP_DEVICE
        ) {
            return 'started';
        }
        if (
            activeSubStep &&
            ['recovery-card-front', 'recovery-card-back'].includes(activeSubStep) &&
            !deviceCall.isProgress
        ) {
            return activeSubStep;
        }
        if (features.needs_backup && !deviceCall.isProgress) {
            return 'initial';
        }
        return null;
    };

    // TODO: rework this step to 2 separate components for T1 and T2, this is mess.
    return (
        <Wrapper.Step>
            <Wrapper.StepHeading>
                {getStatus() === 'initial' && 'Backup your device'}
                {getStatus() === 'success' && 'Backup finished'}
                {getStatus() === 'failed' && 'Backup failed'}
                {getStatus() === 'started' &&
                    model === 1 &&
                    typeof uiInteraction.counter === 'number' &&
                    uiInteraction.counter < 24 &&
                    'Write down seed words from your device'}
                {getStatus() === 'started' &&
                    typeof uiInteraction.counter === 'number' &&
                    uiInteraction.counter >= 24 &&
                    'Check seed words'}
                {getStatus() === 'recovery-card-front' && 'Get your recovery card'}
                {getStatus() === 'recovery-card-back' && 'Get your recovery card'}
            </Wrapper.StepHeading>
            <Wrapper.StepBody>
                {getStatus() === 'initial' && (
                    <>
                        <P>
                            <Translation
                                {...l10nMessages.TR_BACKUP_SUBHEADING_1}
                                values={{
                                    TR_SEED_MANUAL_LINK: (
                                        <Link href={SEED_MANUAL_URL}>
                                            <Translation {...l10nMessages.TR_SEED_MANUAL_LINK} />
                                        </Link>
                                    ),
                                }}
                            />
                        </P>
                        <P>
                            <Translation {...l10nMessages.TR_BACKUP_SUBHEADING_2} />
                        </P>

                        <Instructions />

                        <Panel>
                            <Translation
                                {...l10nMessages.TR_SATOSHILABS_CANNOT_BE_HELD_RESPONSIBLE}
                            />
                        </Panel>
                        <Wrapper.Checkbox>
                            <Checkbox
                                isChecked={userUnderstands}
                                onClick={() => setUserUnderstands(!userUnderstands)}
                            >
                                <P>
                                    <Translation {...l10nMessages.TR_I_HAVE_READ_INSTRUCTIONS} />
                                </P>
                            </Checkbox>
                        </Wrapper.Checkbox>

                        <Wrapper.Controls>
                            {model === 1 && (
                                <OnboardingButton.Cta
                                    onClick={() => {
                                        props.goToSubStep('recovery-card-front');
                                    }}
                                    isDisabled={!device || !userUnderstands}
                                >
                                    Continue
                                </OnboardingButton.Cta>
                            )}

                            {model === 2 && (
                                <OnboardingButton.Cta
                                    onClick={() => props.backupDevice()}
                                    isDisabled={!device || !userUnderstands}
                                >
                                    <Translation {...l10nMessages.TR_START_BACKUP} />
                                </OnboardingButton.Cta>
                            )}
                        </Wrapper.Controls>
                    </>
                )}

                {getStatus() === 'recovery-card-front' && (
                    <>
                        <Text>
                            This is your recovery card. You should find two of them in the package.
                            In few moments, this piece of paper will become more important than your
                            device.
                        </Text>
                        <SeedCard flipOnMouseOver counter={uiInteraction.counter} />
                        <Wrapper.Controls>
                            <OnboardingButton.Cta
                                onClick={() => {
                                    props.goToSubStep('recovery-card-back');
                                }}
                            >
                                Flip it
                            </OnboardingButton.Cta>
                        </Wrapper.Controls>
                    </>
                )}

                {getStatus() === 'recovery-card-back' && (
                    <>
                        <Text>
                            Device will show you a secret sequence of words. You should write them
                            down here.
                        </Text>
                        <SeedCard showBack counter={uiInteraction.counter} />
                        <Wrapper.Controls>
                            <OnboardingButton.Cta
                                onClick={() => {
                                    props.backupDevice();
                                }}
                            >
                                <Translation {...l10nMessages.TR_START_BACKUP} />
                            </OnboardingButton.Cta>
                        </Wrapper.Controls>
                    </>
                )}

                {getStatus() === 'started' && model === 1 && (
                    <>
                        <SeedCard showBack counter={uiInteraction.counter} />
                        <PromptWrapper>
                            <Prompt model={model} size={32}>
                                {typeof uiInteraction.counter === 'number' &&
                                    uiInteraction.counter >= 24 && (
                                        <Text>
                                            Check the {uiInteraction.counter - 23}. word on your
                                            device
                                        </Text>
                                    )}
                                {typeof uiInteraction.counter === 'number' &&
                                    uiInteraction.counter < 24 && (
                                        <Text>
                                            Write down the {uiInteraction.counter + 1}. word from
                                            your device
                                        </Text>
                                    )}
                            </Prompt>
                        </PromptWrapper>
                    </>
                )}

                {getStatus() === 'failed' && (
                    <>
                        <P>
                            <Translation
                                {...l10nMessages.TR_DEVICE_DISCONNECTED_DURING_ACTION_DESCRIPTION}
                            />
                        </P>

                        <P>Once you click retry, device will ask you to confirm these steps:</P>
                        <P>1. wipe device</P>
                        <P>2. create new wallet</P>
                        <P>3. start backup again</P>

                        <Wrapper.Controls>
                            {!deviceCall.isProgress && (
                                <>
                                    <OnboardingButton.Cta
                                        onClick={() => {
                                            props.retryBackup();
                                        }}
                                        isDisabled={!device || !device.connected}
                                    >
                                        <Translation {...l10nCommonMessages.TR_RETRY} />
                                    </OnboardingButton.Cta>
                                    <OnboardingButton.Alt
                                        onClick={() => {
                                            props.goto('wallet-index');
                                        }}
                                        isDisabled={!device || !device.connected}
                                    >
                                        Go to wallet
                                    </OnboardingButton.Alt>
                                </>
                            )}
                        </Wrapper.Controls>
                    </>
                )}

                {getStatus() === 'success' && (
                    <>
                        <Text>
                            <Translation {...l10nMessages.TR_BACKUP_FINISHED_TEXT} />
                        </Text>

                        <Wrapper.Controls>
                            <OnboardingButton.Cta onClick={() => props.goToNextStep()}>
                                <Translation {...l10nMessages.TR_BACKUP_FINISHED_BUTTON} />
                            </OnboardingButton.Cta>
                        </Wrapper.Controls>
                    </>
                )}
            </Wrapper.StepBody>
        </Wrapper.Step>
    );
};

export default BackupStep;
