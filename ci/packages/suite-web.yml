.run_everything_rules: &run_everything_rules
  refs:
    - develop
    - releases
    - schedules
    - /^release\//

# build

suite-web build dev:
  stage: build
  script:
    - yarn install --frozen-lockfile --cache-folder .yarn --prefer-offline
    - yarn build:libs
    - assetPrefix=/suite-web/${CI_BUILD_REF_NAME}/web yarn workspace @trezor/suite-web build
  artifacts:
    expire_in: 7 days
    paths:
      - packages/suite-web/build

suite-web build beta:
  stage: build
  only:
    <<: *run_everything_rules
  script:
    - yarn install --frozen-lockfile --cache-folder .yarn --prefer-offline
    - yarn build:libs
    - assetPrefix=/wallet/web yarn workspace @trezor/suite-web build
  artifacts:
    expire_in: 7 days
    paths:
      - packages/suite-web/scripts/s3sync.sh
      - packages/suite-web/build

suite-web build stable:
  stage: build
  only:
    <<: *run_everything_rules
  script:
    - yarn install --frozen-lockfile --cache-folder .yarn --prefer-offline
    - yarn build:libs
    - assetPrefix=/web yarn workspace @trezor/suite-web build
  artifacts:
    expire_in: 7 days
    paths:
      - packages/suite-web/scripts/s3sync.sh
      - packages/suite-web/build

# deploy

suite-web deploy dev:
  stage: deploy to dev
  variables:
    DEPLOY_DIRECTORY: ${DEPLOY_BASE_DIR}/suite-web/${CI_BUILD_REF_NAME}
  needs:
    - suite-web-landing build dev
    - suite-web build dev
  environment:
    name: ${CI_BUILD_REF_NAME}
    url: $BASE_REVIEW_URL/${CI_BUILD_REF_NAME}
  before_script: []
  script:
    - mkdir -p ${DEPLOY_DIRECTORY}/web
    - rsync --delete -va packages/suite-web-landing/build/ "${DEPLOY_DIRECTORY}/"
    - rsync --delete -va packages/suite-web/build/ "${DEPLOY_DIRECTORY}/web/"
  tags:
    - deploy

# e2e

.e2e web:
  stage: integration testing
  image: registry.gitlab.com/satoshilabs/trezor/trezor-suite/base@sha256:94febe6dbcbd7a64a788bae6350601743201d0c57789b2fe4f7d9c91a64a8837
  needs:
    - suite-web deploy dev
  variables:
    COMPOSE_PROJECT_NAME: $CI_JOB_ID
    COMPOSE_FILE: ./docker/docker-compose.suite-ci.yml
    CYPRESS_ASSET_PREFIX: /web
    CYPRESS_baseUrl: ${DEV_SERVER_URL}/suite-web/${CI_BUILD_REF_NAME}
    CYPRESS_SNAPSHOT: 0
    TRACK_SUITE_URL: https://track-suite.herokuapp.com
  script:
    - yarn install --pure-lockfile --cache-folder .yarn --prefer-offline
    - docker-compose pull
    - docker-compose up -d trezor-user-env-unix
    - sleep 5
    - docker-compose run test-run
  after_script:
    - docker-compose down
  artifacts:
    expire_in: 7 days
    when: always
    paths:
      - ./packages/integration-tests/projects/suite-web/snapshots
      - ./packages/integration-tests/projects/suite-web/screenshots
      - ./packages/integration-tests/projects/suite-web/videos

e2e web suite:
  extends: .e2e web
  variables:
    TEST_GROUP: '@group:suite'

e2e web onboarding:
  extends: .e2e web
  variables:
    TEST_GROUP: '@group:onboarding'

e2e web device-management:
  extends: .e2e web
  variables:
    TEST_GROUP: '@group:device-management'

e2e web settings:
  extends: .e2e web
  variables:
    TEST_GROUP: '@group:settings'

e2e web metadata:
  extends: .e2e web
  variables:
    TEST_GROUP: '@group:metadata'

# TODO scheduled jobs against beta chrome channel
# TODO scheduled jobs against suite.trezor.io

suite-web deploy staging-suite:
  stage: deploy to staging
  needs:
    - suite-web build stable
    - suite-desktop build mac
    - suite-desktop build linux
    - suite-desktop build windows
  environment:
    name: ${CI_BUILD_REF_NAME}-staging-suite
    url: ${STAGING_SUITE_SERVER_URL}
  before_script: []
  only:
    <<: *run_everything_rules
  when: manual
  script:
    - source ${STAGING_SUITE_DEPLOY_KEYFILE}
    - mkdir -p packages/suite-web/build/static/desktop
    - 'rsync --delete -va "${DESKTOP_APP_NAME}"-*.AppImage ./packages/suite-web/build/static/desktop || :'
    - 'rsync --delete -va "${DESKTOP_APP_NAME}"-*.dmg ./packages/suite-web/build/static/desktop || :'
    - 'rsync --delete -va "${DESKTOP_APP_NAME}"-*.exe ./packages/suite-web/build/static/desktop || :'
    - cd packages/suite-web
    - ./scripts/s3sync.sh staging-suite
  tags:
    - deploy
