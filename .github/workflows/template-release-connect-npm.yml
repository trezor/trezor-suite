name: "[Template] NPM Connect deploy"

on:
  workflow_call:
    inputs:
      deploymentType:
        description: Specifies the deployment type for the npm package. Choose 'beta' for pre-release versions that are not ready for production use, and 'production' for stable versions intended for end-users.
        required: true
        type: choice
        options:
          - beta
          - production
      packageName:
        description: The name of the package to be deployed. Select from the predefined list of packages.
        required: true
        type: choice
        options:
          - blockchain-link-types
          - blockchain-link-utils
          - blockchain-link
          - connect-common
          - transport
          - utils
          - utxo-lib
          - connect-plugin-stellar
          - connect-plugin-ethereum
          - analytics
          - connect-analytics
          - type-utils
          - env-utils
          - protocol
          - protobuf
          - schema-utils
          - connect
          - connect-web
          - connect-webextension

jobs:
  build-deploy-connect:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract branch name
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: yarn

      - name: Install dependencies
        run: yarn install --immutable

      - name: Check version
        run: node ./ci/scripts/check-version ${{ inputs.package }} ${{ steps.extract_branch.outputs.branch }} ${{ inputs.deploymentType }}

      - name: Set NPM token
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: yarn config set npmAuthToken ${{ secrets.NPM_TOKEN }}

      - name: Publish to NPM
        run: |
          cd ./packages/${{ inputs.package }}
          yarn npm publish --tag ${{ inputs.deploymentType }} --access public

      - name: Cleanup
        if: always()
        run: yarn config unset npmAuthToken
